<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Links ULTRA</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        /* BASE CSS */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; transition: background 0.3s ease; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); transition: background 0.3s ease, box-shadow 0.3s ease; }
        h1, h2 { color: #667eea; margin-bottom: 30px; text-align: center; font-size: 2.5em; transition: color 0.3s ease; }
        h2 { font-size: 1.5em; text-align: left; }
        
        /* DARK MODE STYLES */
        body.dark-mode { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e0e0e0; }
        body.dark-mode .container { background: #222a3d; box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        body.dark-mode h1, body.dark-mode h2 { color: #9ab4f3; }
        body.dark-mode .add-link-form { background: #2f3b52; border-color: #9ab4f3; }
        body.dark-mode .form-group label { color: #ccc; }
        body.dark-mode input, body.dark-mode textarea, body.dark-mode select { background: #3c4a63; border-color: #5568d3; color: #e0e0e0; }
        body.dark-mode input:focus, body.dark-mode textarea:focus, body.dark-mode select:focus { border-color: #9ab4f3; }
        body.dark-mode .btn-primary { background: #9ab4f3; color: #222a3d; }
        body.dark-mode .btn-primary:hover { background: #7c9ded; }
        body.dark-mode .btn-secondary { background: #5a6a7c; color: #e0e0e0; }
        body.dark-mode .btn-secondary:hover { background: #6d7e8f; }
        body.dark-mode .link-item { background: #2f3b52; border-color: #3c4a63; }
        body.dark-mode .link-item.favorite { border-color: #ffd700; background: #3e4b67; }
        body.dark-mode .link-item:hover { box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
        body.dark-mode .link-title { color: #9ab4f3; }
        body.dark-mode .link-url { color: #aaa; }
        body.dark-mode .link-description, body.dark-mode .description-text { color: #ccc; }
        body.dark-mode .link-category { background: #5568d3; color: #e0e0e0; }
        body.dark-mode .link-notes { background: #3c4a63; border-color: #5568d3; color: #e0e0e0; }
        body.dark-mode .empty-state h3, body.dark-mode .empty-state p { color: #999; }
        body.dark-mode .move-modal-content { background: #2f3b52; }
        body.dark-mode .move-modal h3 { color: #9ab4f3; }
        body.dark-mode .toolbar { background: #2f3b52; border-color: #3c4a63; }
        body.dark-mode .toolbar label { color: #ccc; }
        body.dark-mode .utility-box { background: #2f3b52; border-color: #3c4a63; }
        body.dark-mode .utility-box h2 { color: #9ab4f3; }
        body.dark-mode .utility-box p { color: #aaa; }
        body.dark-mode .icon-btn { color: #ccc; } /* Default icon color for dark mode */
        body.dark-mode .edit-btn { color: #2ecc71; }
        body.dark-mode .favorite-btn { color: #ffd700; }
        body.dark-mode .move-btn { color: #9ab4f3; }
        body.dark-mode .delete-btn { color: #ff4757; }
        body.dark-mode .link-category .icon-btn { color: #e0e0e0; }
        body.dark-mode .title-input, body.dark-mode .description-input, body.dark-mode .category-select-inline {
            background: #3c4a63; border-color: #9ab4f3; color: #9ab4f3;
        }
        body.dark-mode .description-input { color: #e0e0e0; }
        body.dark-mode .category-select-inline { color: #e0e0e0; }


        /* General Styling (unchanged from previous version unless noted) */
        .add-link-form { background: #f8f9ff; padding: 25px; border-radius: 15px; margin-bottom: 30px; border: 2px solid #667eea; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #333; font-weight: 600; }
        input[type="text"], input[type="url"], textarea, input[type="number"], select, #searchInput { 
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: border 0.3s; 
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; }
        textarea { resize: vertical; min-height: 80px; }
        
        /* Buttons */
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #95a5a6; color: white; margin-right: 10px; }
        .btn-secondary:hover { background: #7f8c8d; }

        /* Link Items */
        .link-item { 
            background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #e0e0e0; transition: all 0.3s; position: relative; 
            cursor: grab; /* Indica que o item é arrastável */
        }
        .link-item:active { cursor: grabbing; }
        .link-item:hover { box-shadow: 0 5px 20px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .link-item.favorite { border-color: #ffd700; background: #fffdf0; }
        .link-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; flex-wrap: wrap; }
        .link-title { color: #667eea; font-size: 1.3em; font-weight: 700; text-decoration: none; flex: 1; word-break: break-word; display: flex; align-items: center; }
        .link-title:hover { text-decoration: underline; }
        .link-url { color: #999; font-size: 0.9em; word-break: break-all; margin-bottom: 10px; }
        .link-category { background: #ecf0f1; color: #34495e; padding: 3px 8px; border-radius: 5px; font-size: 0.8em; font-weight: 600; margin-left: 10px; display: inline-flex; align-items: center; gap: 5px;}
        .link-category .icon-btn { font-size: 14px; padding: 0; margin-left: 5px; color: #34495e; }

        /* NEW: Edit-in-place styles */
        .title-input, .description-input, .category-select-inline {
            width: calc(100% - 30px); /* Adjust for actions */
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: 700;
            color: #667eea;
            background: white;
            margin-bottom: 10px;
        }
        .description-input {
            font-size: 1em;
            font-weight: normal;
            color: #333;
            min-height: 60px;
        }
        .category-select-inline {
            font-size: 1em;
            font-weight: 600;
            color: #34495e;
            width: auto; /* Adjust to content */
            min-width: 150px;
            margin-bottom: 10px;
        }


        /* Actions and Modal */
        .link-actions { display: flex; gap: 8px; flex-shrink: 0; margin-left: auto; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; transition: transform 0.2s; color: #666; }
        .icon-btn:hover { transform: scale(1.2); }
        .favorite-btn { color: #ffd700; }
        .move-btn { color: #667eea; }
        .delete-btn { color: #ff4757; }
        
        .move-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .move-modal.active { display: flex; }
        .move-modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }

        /* NEW: Toolbar & Utility */
        .toolbar { 
            display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; 
            margin-bottom: 20px; padding: 15px; border-radius: 10px; background: #f0f4ff; border: 1px solid #ddd;
        }
        .toolbar-group { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .toolbar label { margin: 0; font-weight: 700; color: #333; }
        .utility-box { background: #ecf0f1; padding: 20px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #bdc3c7; }
        #linksList { min-height: 50px; } /* Ensures space for Drag and Drop */

        /* NEW: Dark Mode Toggle */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dark-mode-toggle:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        body.dark-mode .dark-mode-toggle {
            background: #9ab4f3;
            color: #222a3d;
        }
        body.dark-mode .dark-mode-toggle:hover {
            background: #7c9ded;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            margin-top: 30px;
            color: #999;
        }
        .empty-state svg {
            width: 50px;
            height: 50px;
            margin-bottom: 10px;
        }
        .empty-state h3 {
            font-size: 1.5em;
            color: #666;
            margin-bottom: 5px;
        }
        .empty-state p {
            font-size: 1em;
            color: #999;
        }
        body.dark-mode .empty-state {
            border-color: #3c4a63;
        }


        /* Responsiveness */
        @media (max-width: 600px) {
            .container { padding: 20px; }
            h1 { font-size: 1.8em; }
            .link-header { flex-direction: column; align-items: stretch; }
            .link-actions { margin-top: 10px; justify-content: flex-end; }
            .link-title { flex-direction: column; align-items: flex-start; }
            .link-category { margin-left: 0; margin-top: 5px; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .toolbar-group { flex-direction: column; align-items: stretch; gap: 5px; }
            .toolbar .btn { width: 100%; }
            .dark-mode-toggle { top: 10px; right: 10px; width: 35px; height: 35px; font-size: 1em; }
        }
    </style>
</head>
<body>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Alternar Tema">🌙</button>

    <div class="container">
        <h1>📚 Gerenciador de Links ULTRA</h1>

        <div class="utility-box">
            <h2 style="margin-bottom: 15px;">💾 Backup de Dados</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                <button class="btn btn-primary" onclick="exportLinks()">Exportar (Download JSON)</button>
                <input type="file" id="importFile" accept=".json" style="width: auto; flex-grow: 1; padding: 5px;" onchange="importLinks()">
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Importar (Upload JSON)</button>
            </div>
            <p style="margin-top: 10px; font-size: 0.85em; color: #7f8c8d;">Use o backup para salvar e restaurar seus links em outro dispositivo.</p>
        </div>
        
        <div class="add-link-form">
            <h2 style="margin-bottom: 20px;">➕ Adicionar Novo Link</h2>
            <div class="form-group">
                <label for="linkUrl">URL do Link:</label>
                <input type="url" id="linkUrl" placeholder="https://exemplo.com" required>
            </div>
            <div class="form-group">
                <label for="linkTitle">Título:</label>
                <input type="text" id="linkTitle" placeholder="Título do link" required>
            </div>
            <div class="form-group">
                <label for="linkCategory">Categoria:</label>
                <select id="linkCategory">
                    <option value="Sem Categoria">Sem Categoria</option>
                    <option value="Desenvolvimento">Desenvolvimento</option>
                    <option value="Finanças">Finanças</option>
                    <option value="Utilidades">Utilidades</option>
                    <option value="Pessoal">Pessoal</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
            <div class="form-group">
                <label for="linkDescription">Descrição:</label>
                <textarea id="linkDescription" placeholder="Descrição do link"></textarea>
            </div>
            <button class="btn btn-primary" onclick="addLink()">Adicionar Link</button>
        </div>
        
        <div class="add-link-form" style="padding: 15px 25px; margin-bottom: 30px;">
            <h2 style="margin-bottom: 20px;">🔍 Filtros e Ordenação</h2>
            
            <div class="form-group">
                <label for="searchInput">Pesquisar:</label>
                <input type="text" id="searchInput" oninput="renderLinks()" placeholder="Título, URL, descrição ou notas...">
            </div>

            <div class="toolbar">
                <div class="toolbar-group">
                    <label for="filterCategory">Filtrar por Categoria:</label>
                    <select id="filterCategory" onchange="renderLinks()">
                        <option value="all">Todas as Categorias</option>
                        </select>
                </div>
                
                <div class="toolbar-group">
                    <button class="btn btn-secondary" onclick="sortLinks('favorite')">⭐ Favoritos no Topo</button>
                    <button class="btn btn-secondary" onclick="sortLinks('title')">A-Z / Z-A</button>
                </div>
            </div>
        </div>
        <div id="linksList"></div>
    </div>

    <div class="move-modal" id="moveModal">
        <div class="move-modal-content">
            <h3>Mover Link</h3>
            <div class="move-options" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="moveToPosition('first')">⬆️ Mover para Primeira</button>
                <button class="btn btn-primary" onclick="moveToPosition('last')">⬇️ Mover para Última</button>
            </div>
            
            <div class="position-input-group" style="margin-bottom: 20px;">
                <label for="targetPosition">Mover para a linha (1 - <span id="maxPosition">1</span>):</label>
                <input type="number" id="targetPosition" placeholder="Ex: 5" min="1" style="width: 100%; margin-top: 5px;">
                <button class="btn btn-primary" style="margin-top: 10px; width: 100%;" onclick="moveLinkToSpecificPosition()">Mover para Posição</button>
            </div>

            <button class="btn" style="background: #95a5a6; color: white; width: 100%;" onclick="closeMoveModal()">Cancelar</button>
        </div>
    </div>

    <script>
        const initialLinks = [
            { url: 'https://asl43.github.io/repositorio-/', title: 'REPOSITORIO DE LINKS', description: 'Link do próprio Gerenciador de Links.', notes: '', favorite: true, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/rifa_solidaria/', title: 'Rifa Solidária – Castração de Cães e Gatos', description: '', notes: '', favorite: false, category: 'Pessoal' },
            { url: 'https://asl43.github.io/Futebol/', title: 'Futebol', description: '', notes: '', favorite: false, category: 'Outros' },
            { url: 'https://asl43.github.io/Alarme/', title: 'Alarme', description: '', notes: '', favorite: false, category: 'Utilidades' },
            { url: 'https://asl43.github.io/Sv_diario/', title: 'SV Diário', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://github.com/asl43/Registro_SV', title: 'Registro SV', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/Link_utilidades/', title: 'Link Utilidades', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/Futebol1/', title: 'Futebol 1', description: '', notes: '', favorite: false, category: 'Outros' },
            { url: 'https://github.com/asl43/SV_relatorio', title: 'SV Relatório', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/Conversortextoavancado/', title: 'Conversor Texto Avançado', description: '', notes: '', favorite: false, category: 'Utilidades' },
            { url: 'https://github.com/asl43/SistemacontroleVTR', title: 'Sistema Controle VTR', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/Monitor-investimento-/', title: 'Monitor Investimento', description: '', notes: '', favorite: false, category: 'Finanças' },
            { url: 'https://asl43.github.io/Gerenciador-arquivo-/', title: 'Gerenciador Arquivo', description: '', notes: '', favorite: false, category: 'Utilidades' },
            { url: 'https://asl43.github.io/System-de-estudos-/', title: 'System de Estudos', description: '', notes: '', favorite: false, category: 'Pessoal' },
            { url: 'https://asl43.github.io/rifa_beneficente/', title: 'Rifa Beneficente', description: '', notes: '', favorite: false, category: 'Pessoal' },
            { url: 'https://github.com/asl43/Bin', title: 'Bin', description: '', notes: '', favorite: false, category: 'Outros' },
            { url: 'https://asl43.github.io/Audio/', title: 'Audio', description: '', notes: '', favorite: false, category: 'Utilidades' },
            { url: 'https://asl43.github.io/Bing/', title: 'Bing', description: '', notes: '', favorite: false, category: 'Outros' },
            { url: 'https://asl43.github.io/Encurto/', title: 'Encurtador', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://github.com/asl43/Sudoku', title: 'Sudoku', description: '', notes: '', favorite: false, category: 'Outros' },
            { url: 'https://github.com/asl43/Gest', title: 'Gest', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://github.com/asl43/Gest-or', title: 'Gestor', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://github.com/asl43/Click', title: 'Click', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/Energia-consumo/', title: 'Energia Consumo', description: '', notes: '', favorite: false, category: 'Finanças' },
            { url: 'https://asl43.github.io/Gest-sv/', title: 'Gest SV', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/aguaia/', title: 'Aguaia', description: '', notes: '', favorite: false, category: 'Outros' },
            { url: 'https://asl43.github.io/Financy/', title: 'Financy', description: '', notes: '', favorite: false, category: 'Finanças' },
            { url: 'https://asl43.github.io/Pet/', title: 'Pet', description: '', notes: '', favorite: false, category: 'Pessoal' },
            { url: 'https://asl43.github.io/Gps/', title: 'GPS', description: '', notes: '', favorite: false, category: 'Utilidades' },
            { url: 'https://asl43.github.io/CONVERTMP3/', title: 'Converter MP3', description: '', notes: '', favorite: false, category: 'Utilidades' },
            { url: 'https://asl43.github.io/Creacao-vd/', title: 'Criação VD', description: '', notes: '', favorite: false, category: 'Utilidades' },
            { url: 'https://asl43.github.io/Anota-es/', title: 'Anotações', description: '', notes: '', favorite: false, category: 'Pessoal' },
            { url: 'https://asl43.github.io/Calend-rio-e-LEMBRETES-/', title: 'Calendário e Lembretes', description: '', notes: '', favorite: false, category: 'Pessoal' },
            { url: 'https://asl43.github.io/mp43/', title: 'MP4', description: '', notes: '', favorite: false, category: 'Outros' },
            { url: 'https://asl43.github.io/Edi-o-foto/', title: 'Edição Foto', description: '', notes: '', favorite: false, category: 'Utilidades' },
            { url: 'https://asl43.github.io/Recicl/', title: 'Reciclagem', description: '', notes: '', favorite: false, category: 'Outros' },
            { url: 'https://asl43.github.io/Compara/', title: 'Comparador', description: '', notes: '', favorite: false, category: 'Utilidades' },
            { url: 'https://asl43.github.io/Autoagendar/', title: 'Auto Agendar', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/Imgdesenh/', title: 'Img Desenho', description: '', notes: '', favorite: false, category: 'Outros' },
            { url: 'https://asl43.github.io/BLOCO/', title: 'Bloco', description: '', notes: '', favorite: false, category: 'Pessoal' },
            { url: 'https://github.com/asl43/ANALIZADOR', title: 'Analisador', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://github.com/asl43/Analy-tel', title: 'Analy Tel', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            // Chtbot mapeado para o link do Chat-pwa, conforme instrução
            { url: 'https://asl43.github.io/Chat-pwa/', title: 'Chatbot', description: '', notes: '', favorite: false, category: 'Desenvolvimento' }, 
            { url: 'https://asl43.github.io/Chat-pwa/', title: 'Chat PWA', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/Botcht/', title: 'Bot Chat', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/Integracbot/', title: 'Integração Bot', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://github.com/asl43/gest-sv2', title: 'Gest SV 2', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://github.com/asl43/gest-sv3', title: 'Gest SV 3', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://github.com/asl43/gest-sv4', title: 'Gest SV 4', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/contrutor-de-chatbot-/', title: 'Construtor de Chatbot', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/Chat_Interno/', title: 'Chat Interno', description: '', notes: '', favorite: false, category: 'Desenvolvimento' },
            { url: 'https://asl43.github.io/SMART-AGENDA/', title: 'Smart Agenda', description: '', notes: '', favorite: false, category: 'Pessoal' },
            { url: 'https://asl43.github.io/SMART-AGENDA-SIMILAR/', title: 'Smart Agenda Similar', description: '', notes: '', favorite: false, category: 'Pessoal' },
            { url: 'https://asl43.github.io/Agend/', title: 'Agenda', description: '', notes: '', favorite: false, category: 'Pessoal' },
            { url: 'https://asl43.github.io/EMPENHO-DO-J/', title: 'Empenho de J', description: '', notes: '', favorite: false, category: 'Finanças' }
        ];

        // --- Variáveis Globais ---
        let links = loadLinks(); 
        let currentMoveIndex = null;
        let sortDirection = 1; // 1 for A-Z/Asc, -1 for Z-A/Desc
        
        // --- FUNÇÕES DE DARK MODE ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            updateDarkModeToggleIcon();
        }

        function loadDarkModePreference() {
            const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");
            const savedPreference = localStorage.getItem('darkMode');

            if (savedPreference === 'true' || (savedPreference === null && prefersDarkScheme.matches)) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            updateDarkModeToggleIcon();
        }

        function updateDarkModeToggleIcon() {
            const toggleButton = document.querySelector('.dark-mode-toggle');
            if (toggleButton) {
                toggleButton.textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';
            }
        }
        
        // --- FUNÇÕES DE PERSISTÊNCIA (localStorage) ---

        function loadLinks() {
            try {
                const savedLinks = localStorage.getItem('myLinkManagerLinks');
                if (savedLinks) {
                    const parsedLinks = JSON.parse(savedLinks);
                    return parsedLinks.map(link => ({ 
                        ...link, 
                        category: link.category || 'Sem Categoria',
                        // Garante que as flags de edição estejam em estado inicial
                        editingTitle: false, 
                        editingDescription: false,
                        editingCategory: false
                    }));
                }
                // Retorna os links iniciais se não houver nada salvo
                return initialLinks.map(link => ({ 
                    ...link, 
                    category: link.category || 'Sem Categoria',
                    editingTitle: false,
                    editingDescription: false,
                    editingCategory: false
                }));
            } catch (e) {
                console.error("Erro ao carregar links do localStorage:", e);
                // Se o localStorage estiver corrompido, volta para o array inicial
                return initialLinks;
            }
        }

        function saveLinks() {
            try {
                // Ao salvar, remove as flags de edição para não persistir no armazenamento
                const linksToSave = links.map(link => {
                    const { editingTitle, editingDescription, editingCategory, ...rest } = link;
                    return rest;
                });
                localStorage.setItem('myLinkManagerLinks', JSON.stringify(linksToSave));
            } catch (e) {
                console.error("Erro ao salvar links no localStorage:", e);
                alert("Aviso: Falha ao salvar os links. Seu armazenamento local pode estar cheio ou inacessível.");
            }
        }

        // --- FUNÇÕES DE BACKUP (Exportar/Importar) ---

        function exportLinks() {
            const dataStr = JSON.stringify(links, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'links_backup.json';

            let linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            alert("Backup exportado com sucesso! Procure por 'links_backup.json' na sua pasta de Downloads.");
        }

        function importLinks() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert("Por favor, selecione um arquivo JSON para importar.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedLinks = JSON.parse(e.target.result);
                    if (Array.isArray(importedLinks)) {
                        if (confirm(`Tem certeza que deseja substituir os ${links.length} links atuais por ${importedLinks.length} links importados? Esta ação é irreversível.`)) {
                            links = importedLinks.map(link => ({ 
                                ...link, 
                                category: link.category || 'Sem Categoria',
                                editingTitle: false,
                                editingDescription: false,
                                editingCategory: false
                            }));
                            saveLinks();
                            renderLinks();
                            alert("Importação concluída com sucesso! Seus novos links foram carregados.");
                        }
                    } else {
                        alert("Formato de arquivo JSON inválido. O arquivo deve conter uma lista (array) de links.");
                    }
                } catch (error) {
                    alert("Erro ao ler o arquivo JSON. Verifique se o formato está correto. Detalhes: " + error.message);
                    console.error("Erro de importação:", error);
                } finally {
                    // Limpa o input de arquivo
                    fileInput.value = '';
                }
            };
            reader.readAsText(file);
        }

        // --- FUNÇÕES DE RENDERIZAÇÃO E FILTRO ---

        function getUniqueCategoriesWithCount() {
            const categoryCounts = {};
            links.forEach(link => {
                const category = link.category || 'Sem Categoria';
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            // Ordena as categorias por nome
            const sortedCategories = Object.keys(categoryCounts).sort();
            return sortedCategories.map(category => ({
                name: category,
                count: categoryCounts[category]
            }));
        }

        function populateCategoryFilters() {
            const filterSelect = document.getElementById('filterCategory');
            const linkCategorySelect = document.getElementById('linkCategory');
            const uniqueCategoriesWithCount = getUniqueCategoriesWithCount();
            const currentFilter = filterSelect.value;
            
            // 1. Atualizar o filtro de pesquisa (toolbar)
            filterSelect.innerHTML = '<option value="all">Todas as Categorias (' + links.length + ')</option>';
            
            uniqueCategoriesWithCount.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = `${cat.name} (${cat.count})`;
                if (cat.name === currentFilter) {
                    option.selected = true;
                }
                filterSelect.appendChild(option);
            });

            // 2. Atualizar o select de adicionar novo link
            const currentNewCategory = linkCategorySelect.value;
            linkCategorySelect.innerHTML = '';
            
            uniqueCategoriesWithCount.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                // Mantém a categoria selecionada se já estiver no formulário
                if (cat.name === currentNewCategory) {
                    option.selected = true;
                }
                linkCategorySelect.appendChild(option);
            });
            // Adiciona a opção "Sem Categoria" se foi removida acidentalmente e não existia nenhuma
            if (!linkCategorySelect.querySelector('option[value="Sem Categoria"]')) {
                const defaultOption = document.createElement('option');
                defaultOption.value = 'Sem Categoria';
                defaultOption.textContent = 'Sem Categoria';
                linkCategorySelect.prepend(defaultOption);
            }
        }

        function renderLinks() {
            const linksList = document.getElementById('linksList');
            const searchValue = document.getElementById('searchInput').value.toLowerCase().trim();
            const filterCategory = document.getElementById('filterCategory').value;

            // 1. Filtrar links
            let filteredLinks = links.filter(link => {
                const searchString = `${link.title} ${link.url} ${link.description} ${link.notes} ${link.category}`.toLowerCase();
                const matchesSearch = searchString.includes(searchValue);
                const matchesCategory = filterCategory === 'all' || link.category === filterCategory;
                return matchesSearch && matchesCategory;
            });
            
            // 2. Popular filtros (precisa ser feito antes do render)
            populateCategoryFilters();

            // 3. Estado vazio
            if (filteredLinks.length === 0) {
                linksList.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                        <h3>${searchValue || filterCategory !== 'all' ? 'Nenhum link encontrado com os filtros atuais' : 'Nenhum link salvo ainda'}</h3>
                        <p>${searchValue || filterCategory !== 'all' ? 'Tente ajustar sua pesquisa ou filtro' : 'Adicione seu primeiro link usando o formulário acima'}</p>
                    </div>
                `;
                return;
            }

            // 4. Renderizar links filtrados
            linksList.innerHTML = filteredLinks.map((link, index) => {
                // Usamos o índice original na lista 'links' para todas as operações de modificação
                const originalIndex = links.findIndex(l => l === link); 
                
                // Conteúdo Principal
                let titleContent, descriptionContent, categoryContent;

                // Título Editável
                if (link.editingTitle) {
                    titleContent = `
                        <input type="text" id="editTitle-${originalIndex}" class="title-input" value="${link.title.replace(/"/g, '&quot;')}" 
                            onblur="saveInlineEdit(${originalIndex}, 'title', this.value)" 
                            onkeydown="if(event.key === 'Enter') { this.blur(); }">
                    `;
                } else {
                    titleContent = `
                        <a href="${link.url}" target="_blank" class="link-title" title="${link.title}">
                            ${link.title}
                        </a>
                    `;
                }

                // Categoria Editável
                const uniqueCategories = getUniqueCategoriesWithCount().map(c => c.name);
                if (link.editingCategory) {
                    categoryContent = `
                        <select id="editCategory-${originalIndex}" class="category-select-inline" 
                            onchange="saveInlineEdit(${originalIndex}, 'category', this.value); renderLinks();">
                            ${uniqueCategories.map(cat => 
                                `<option value="${cat}" ${cat === link.category ? 'selected' : ''}>${cat}</option>`
                            ).join('')}
                        </select>
                    `;
                } else {
                    categoryContent = `
                        <span class="link-category" onclick="toggleInlineEdit(${originalIndex}, 'category')">
                            ${link.category}
                        </span>
                    `;
                }

                // Descrição Editável
                if (link.editingDescription) {
                    descriptionContent = `
                        <textarea id="editDescription-${originalIndex}" class="description-input" 
                            onblur="saveInlineEdit(${originalIndex}, 'description', this.value)">${link.description.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                    `;
                } else {
                    descriptionContent = `
                        <p class="link-description" onclick="toggleInlineEdit(${originalIndex}, 'description')">
                            ${link.description || 'Clique para adicionar uma descrição...'}
                        </p>
                    `;
                }

                return `
                    <div class="link-item ${link.favorite ? 'favorite' : ''}" data-id="${originalIndex}">
                        <div class="link-header">
                            <div style="flex: 1; min-width: 0;">
                                ${titleContent}
                                <p class="link-url">${link.url}</p>
                            </div>
                            <div class="link-actions">
                                <button class="icon-btn edit-btn" title="Editar Título/URL" onclick="toggleInlineEdit(${originalIndex}, 'title')">✏️</button>
                                <button class="icon-btn favorite-btn" title="${link.favorite ? 'Remover dos Favoritos' : 'Adicionar aos Favoritos'}" onclick="toggleFavorite(${originalIndex})">${link.favorite ? '⭐' : '☆'}</button>
                                <button class="icon-btn move-btn" title="Mover Posição" onclick="openMoveModal(${originalIndex})">↕️</button>
                                <button class="icon-btn delete-btn" title="Excluir Link" onclick="deleteLink(${originalIndex})">🗑️</button>
                            </div>
                        </div>
                        
                        ${descriptionContent}
                        ${categoryContent}
                        
                        <details class="link-notes" style="margin-top: 10px;">
                            <summary style="font-weight: 600; cursor: pointer;">Notas (Clique para ${link.notes ? 'Ver/Editar' : 'Adicionar'})</summary>
                            <textarea onblur="saveNotes(${originalIndex}, this.value)" style="width: 100%; border: none; padding: 10px; margin-top: 5px; resize: vertical; border-radius: 5px; background: inherit; color: inherit; border: 1px solid #ccc;">${link.notes}</textarea>
                        </details>
                    </div>
                `;
            }).join('');

            // 5. Reaplicar SortableJS após a renderização
            initializeSortable();
        }

        // --- FUNÇÕES DE CRUD (Adicionar, Excluir, Mover) ---

        function addLink() {
            const urlInput = document.getElementById('linkUrl');
            const titleInput = document.getElementById('linkTitle');
            const categoryInput = document.getElementById('linkCategory');
            const descriptionInput = document.getElementById('linkDescription');

            const url = urlInput.value.trim();
            const title = titleInput.value.trim();
            const category = categoryInput.value.trim() || 'Sem Categoria';
            const description = descriptionInput.value.trim();

            if (url === '' || title === '') {
                alert('URL e Título são obrigatórios.');
                return;
            }

            const newLink = {
                url,
                title,
                description,
                notes: '',
                favorite: false,
                category: category 
            };

            links.unshift(newLink); // Adiciona no topo
            saveLinks();
            renderLinks();

            // Limpa o formulário
            urlInput.value = '';
            titleInput.value = '';
            descriptionInput.value = '';
            categoryInput.value = 'Sem Categoria';
        }

        function deleteLink(index) {
            if (confirm(`Tem certeza que deseja excluir o link "${links[index].title}"?`)) {
                links.splice(index, 1);
                saveLinks();
                renderLinks();
            }
        }

        function toggleFavorite(index) {
            links[index].favorite = !links[index].favorite;
            saveLinks();
            renderLinks();
        }

        function saveNotes(index, notes) {
            links[index].notes = notes;
            saveLinks();
        }

        // --- EDIÇÃO INLINE (Novo) ---

        function toggleInlineEdit(index, field) {
            // Desativa qualquer edição ativa para evitar múltiplos inputs abertos
            links.forEach((link, i) => {
                if (i !== index) {
                    link.editingTitle = false;
                    link.editingDescription = false;
                    link.editingCategory = false;
                }
            });

            // Ativa/Desativa o campo específico
            if (field === 'title') {
                links[index].editingTitle = !links[index].editingTitle;
                links[index].editingDescription = false; // Desativa outras edições
                links[index].editingCategory = false;
            } else if (field === 'description') {
                links[index].editingDescription = !links[index].editingDescription;
                links[index].editingTitle = false;
                links[index].editingCategory = false;
            } else if (field === 'category') {
                links[index].editingCategory = !links[index].editingCategory;
                links[index].editingTitle = false;
                links[index].editingDescription = false;
            }

            renderLinks();

            // Foca no input após a renderização
            setTimeout(() => {
                if (field === 'title' && links[index].editingTitle) {
                    document.getElementById(`editTitle-${index}`)?.focus();
                } else if (field === 'description' && links[index].editingDescription) {
                    document.getElementById(`editDescription-${index}`)?.focus();
                }
            }, 50);
        }

        function saveInlineEdit(index, field, value) {
            const trimmedValue = value.trim();

            if (field === 'title') {
                if (trimmedValue === '') {
                    alert('O título não pode estar vazio.');
                    // Deixa a flag de edição ativa
                    return; 
                }
                links[index].title = trimmedValue;
                links[index].editingTitle = false;
            } else if (field === 'description') {
                links[index].description = trimmedValue;
                links[index].editingDescription = false;
            } else if (field === 'category') {
                links[index].category = trimmedValue || 'Sem Categoria';
                links[index].editingCategory = false;
            }

            saveLinks();
            renderLinks();
        }

        // --- FUNÇÕES DE ORDENAÇÃO ---

        function sortLinks(type) {
            if (type === 'title') {
                // Inverte a direção se estiver ordenando por título novamente
                sortDirection = sortDirection * -1;
                links.sort((a, b) => a.title.localeCompare(b.title) * sortDirection);
            } else if (type === 'favorite') {
                // Seta a direção para 1 (Asc) para a ordenação A-Z padrão após
                sortDirection = 1; 
                links.sort((a, b) => {
                    // Favoritos (true) vão para o topo
                    if (a.favorite && !b.favorite) return -1;
                    if (!a.favorite && b.favorite) return 1;
                    // Mantém a ordem relativa dos demais links
                    return 0; 
                });
            }

            saveLinks();
            renderLinks();
        }

        // --- DRAG AND DROP (SortableJS) ---

        function initializeSortable() {
            const list = document.getElementById('linksList');
            if (list) {
                new Sortable(list, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    // Função chamada ao soltar o item
                    onEnd: function (evt) {
                        const oldIndex = parseInt(evt.item.getAttribute('data-id'));
                        const newElement = evt.item;
                        const newIndex = Array.from(list.children).findIndex(el => el === newElement);

                        // O SortableJS move o elemento DOM. Precisamos mover o objeto no array 'links'.
                        // O oldIndex e newIndex são baseados nos elementos *visíveis/filtrados*.
                        // Precisamos refazer o mapeamento para garantir que o movimento seja feito na array 'links' principal.
                        
                        // 1. Encontra a posição atual do link movido na array 'links'
                        const draggedLink = links[oldIndex]; 
                        
                        // 2. Cria uma array dos links filtrados/visíveis
                        const searchValue = document.getElementById('searchInput').value.toLowerCase().trim();
                        const filterCategory = document.getElementById('filterCategory').value;
                        const filteredLinks = links.filter(link => {
                            const searchString = `${link.title} ${link.url} ${link.description} ${link.notes} ${link.category}`.toLowerCase();
                            const matchesSearch = searchString.includes(searchValue);
                            const matchesCategory = filterCategory === 'all' || link.category === filterCategory;
                            return matchesSearch && matchesCategory;
                        });

                        // 3. Encontra os índices alvo na array 'links'
                        // Remove o link arrastado da lista principal
                        links.splice(oldIndex, 1);
                        
                        // Encontra o link de referência (o que estava na nova posição)
                        const referenceLink = filteredLinks[newIndex];
                        
                        let targetIndex;
                        if (referenceLink) {
                            // Encontra o índice na array 'links' principal para o link de referência
                            targetIndex = links.findIndex(link => link === referenceLink);
                        } else {
                            // Se não houver referência (moveu para o final da lista visível)
                            targetIndex = links.length;
                        }
                        
                        // Insere o link arrastado na nova posição na lista principal
                        links.splice(targetIndex, 0, draggedLink);

                        saveLinks();
                        renderLinks(); // Renderiza para reordenar os data-id e garantir consistência
                    }
                });
            }
        }
        
        // --- FUNÇÕES DE MODAL DE MOVIMENTAÇÃO POR POSIÇÃO ---

        function openMoveModal(index) {
            currentMoveIndex = index;
            document.getElementById('maxPosition').textContent = links.length;
            document.getElementById('targetPosition').max = links.length;
            document.getElementById('moveModal').classList.add('active');
        }

        function closeMoveModal() {
            document.getElementById('moveModal').classList.remove('active');
            currentMoveIndex = null;
            document.getElementById('targetPosition').value = '';
        }

        function moveLinkInArray(fromIndex, toIndex) {
            if (fromIndex < 0 || fromIndex >= links.length || toIndex < 0 || toIndex >= links.length || fromIndex === toIndex) {
                return;
            }
            
            const [movedLink] = links.splice(fromIndex, 1);
            links.splice(toIndex, 0, movedLink);

            saveLinks();
            renderLinks();
            closeMoveModal();
        }

        function moveToPosition(position) {
            if (currentMoveIndex === null) return;
            
            if (position === 'first') {
                moveLinkInArray(currentMoveIndex, 0);
            } else if (position === 'last') {
                moveLinkInArray(currentMoveIndex, links.length - 1);
            }
        }

        function moveLinkToSpecificPosition() {
            if (currentMoveIndex === null) return;

            const targetPositionInput = document.getElementById('targetPosition');
            let targetPosition = parseInt(targetPositionInput.value);

            if (isNaN(targetPosition) || targetPosition < 1 || targetPosition > links.length) {
                alert(`Por favor, insira um número válido entre 1 e ${links.length}.`);
                return;
            }
            
            // Posição 1 no UI é índice 0 no array, então subtraímos 1
            const targetIndex = targetPosition - 1; 

            moveLinkInArray(currentMoveIndex, targetIndex);
        }

        // --- INICIALIZAÇÃO ---

        document.addEventListener('DOMContentLoaded', () => {
            loadDarkModePreference();
            renderLinks();
            // A inicialização do SortableJS é feita dentro de renderLinks()
        });
    </script>
</body>
</html>
